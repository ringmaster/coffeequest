# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Coffee Quest** is a mobile-first, single-page static site game that integrates with a physical mug featuring a printed map. Players navigate to locations by entering coordinates, complete steps that modify their tags/state, and progress through emergent narratives driven by a tag-based system.

**Live site**: https://ringmaster.github.io/coffeequest

## Build Commands

```bash
npm install          # Install dependencies
npm run dev          # Development server (base path disabled)
npm run build        # Production build (outputs to /build)
npm run preview      # Preview production build
npm run check        # TypeScript type checking
npm run lint         # ESLint
```

## Deployment

- Hosted on GitHub Pages at `/coffeequest` subpath
- Auto-deploys on push to `main` via `.github/workflows/deploy.yml`
- Base path configured in `svelte.config.js` (disabled during dev)
- Use `import { base } from '$app/paths'` for asset URLs

## Directory Structure

```
src/lib/
├── components/          # Svelte components
│   ├── CharacterCreation.svelte   # Initial stat allocation
│   ├── GameHeader.svelte          # Stats display + menu button
│   ├── GameMenu.svelte            # Menu overlay (quest log, reset)
│   ├── LocationEntry.svelte       # Coordinate input
│   ├── QuestLog.svelte            # Quest history overlay
│   ├── SkillCheck.svelte          # Dice roll UI
│   └── StepDisplay.svelte         # Step text + options
├── game/
│   └── engine.ts        # Core logic: step selection, tag filtering, skill checks
├── stores/
│   └── gameState.svelte.ts   # Reactive state + localStorage persistence
└── types/
    └── game.ts          # TypeScript interfaces

quests/                  # Quest content (merged on build)
├── _config.json         # Game config (stats, modifiers)
└── *.json               # Individual quest files

static/
└── steps.json           # GENERATED by vite plugin - do not edit

scripts/
└── vite-plugin-merge-quests.js   # Merges quests/*.json → static/steps.json
```

## Game Mechanics

### Tag System
Steps use prefixed tags for filtering and state:
- `@tag` = required (player must have to see step)
- `!tag` = blocked (player must NOT have)
- `+tag` = grant (add to player on execution)
- `-tag` = consume (remove from player)
- `tag` (no prefix) = preferred (scoring boost)

### Step Selection Algorithm
1. Filter steps by location (coordinate match)
2. Apply hard filters (required/blocked tags)
3. Score remaining by preferred tags
4. Random selection from highest-scored

### Skill Checks
- Options can specify `skill` (might/guile/magic) and `dc` (difficulty class)
- Roll: d6 + stat + modifiers vs DC
- Difficulty displayed based on success probability: easy/basic/hard/challenging/impossible

### Quest Files
Quest files in `quests/` are auto-merged during dev and build:
```json
{
  "name": "Quest Name",
  "description": "Description",
  "steps": [
    {
      "id": "unique_id",
      "location": "A1",           // Map coordinate or virtual location ID
      "tags": ["@required", "+granted"],
      "vars": { "item": ["a", "b", "c"] },  // Random variable assignment
      "text": "Display text with {{item}}",
      "log": "Quest log entry",
      "options": [
        { "label": "Choice", "tags": [], "pass": "next_step_id" },
        { "label": "Skill check", "skill": "guile", "dc": 7, "pass": "success_id", "fail": "fail_id" }
      ]
    }
  ]
}
```

## Key Implementation Details

### State Persistence
- All game state in localStorage under `coffeequest_save`
- Character: `{ might, guile, magic, stepsCompleted, metadata: string[] }`
- Quest variables: `questVars` object for `{{variable}}` interpolation

### Game Phases
`character_creation` → `navigation` → `display_step` → `skill_check_roll` → `skill_check_result` → (loop)

## Svelte 5 Requirements

**Use Runes mode exclusively:**
```svelte
<script lang="ts">
  let count = $state(0);
  let doubled = $derived(count * 2);
  let { prop } = $props();

  // For complex derived logic:
  let filtered = $derived.by(() => {
    return items.filter(i => i.active);
  });
</script>
```

**Never use:**
- Legacy `$:` reactive declarations
- `export let` for props
- `$derived(() => {...})` (use `$derived.by` for function bodies)
