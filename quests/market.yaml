name: Market Square
steps:
  - id: Market
    tags:
      - "!status:banned_from_market"
    vars:
      market_atmosphere:
        - The market square hums with commerce
        - The market bustles with midday crowds
        - Merchants haggle and customers browse throughout the market
        - The market is alive with activity
        - Commerce flows through the market like a river
        - The market thrums with the energy of a dozen deals in progress
        - Voices rise and fall across the crowded market square
        - The market swirls with color and noise
      market_sights:
        - Colorful awnings shade a dozen stalls
        - Canvas tents and wooden carts crowd the square
        - Stalls line the cobblestones in neat rows
        - Merchants have claimed every spare foot of space
        - Bright banners flutter above the vendors' booths
        - The square is packed with carts, tables, and eager sellers
        - Weathered awnings cast welcome shade over the goods below
      market_smells:
        - the smell of spices mingles with woodsmoke
        - the aroma of fresh bread drifts from somewhere nearby
        - scents of leather and lamp oil hang in the air
        - the sharp tang of fish competes with sweeter perfumes
        - woodsmoke and roasting meat flavor the breeze
        - a hundred smells blend into something uniquely 'market'
        - the air carries hints of exotic spices and common cooking
      market_sounds:
        - Merchants call out their wares as you survey your options
        - Vendors compete to catch your eye and your coin
        - The clamor of commerce surrounds you
        - Shopkeepers beckon to passersby with practiced enthusiasm
        - A cacophony of sales pitches fills the air
        - Every merchant seems convinced you need exactly what they're selling
    text: "{{market_atmosphere}}. {{market_sights}}, and {{market_smells}}. {{market_sounds}}."
    options:
      - label: Visit the provisioner's stall
        tags: []
        pass: stall_provisioner
      - label: Visit the apothecary's tent
        tags: []
        pass: stall_apothecary
      - label: Visit the curio dealer's cart
        tags: []
        pass: stall_curios
      - label: Visit the general goods stand
        tags: []
        pass: stall_general
      - label: Leave the market
        tags: []
        pass: null
  - id: Market
    tags:
      - "@status:banned_from_market"
    text: >-
      A guard blocks your path, hand on sword hilt. 'You've got nerve showing your face here, thief. The market is
      closed to you.'
    options:
      - label: Leave quietly
        tags: []
        pass: null
      - label: Try to sneak past
        tags: []
        skill: guile
        dc: 8
        pass: market_sneak_success
        fail: market_sneak_fail
  - id: market_sneak_success
    tags: []
    text: You slip through a gap in the crowd when the guard turns away. You'll need to be quick—and avoid the guards.
    options:
      - label: Hurry to the provisioner
        tags: []
        pass: stall_provisioner
      - label: Hurry to the apothecary
        tags: []
        pass: stall_apothecary
      - label: Hurry to the curio dealer
        tags: []
        pass: stall_curios
      - label: Hurry to general goods
        tags: []
        pass: stall_general
  - id: market_sneak_fail
    tags:
      - +status:injured
    text: >-
      The guard catches you by the collar and throws you to the cobblestones. 'Try that again and it'll be the stocks
      for you.'
    log: Roughed up by market guards
  - id: stall_provisioner
    tags: []
    vars:
      merchant_demeanor:
        - A burly woman
        - A weathered old man
        - A cheerful dwarf
    text: >-
      {{merchant_demeanor}} tends the provisioner's stall, surrounded by coils of rope, iron tools, and practical
      traveling gear.
    options:
      - label: Buy rope (1 silver)
        tags:
          - inv:silver
          - "!inv:rope"
        pass: buy_rope
      - label: Buy lantern (2 silver)
        tags:
          - inv:silver
          - inv:silver
          - "!inv:lantern"
        pass: buy_lantern
      - label: Buy rations (1 silver)
        tags:
          - inv:silver
        pass: buy_rations
      - label: Buy lockpicks (2 silver)
        tags:
          - inv:silver
          - inv:silver
          - "!inv:lockpicks"
        pass: buy_lockpicks
      - label: Browse other stalls
        tags:
          - "!status:banned_from_market"
        pass: Market
      - label: Leave the market
        tags: []
        pass: null
  - id: buy_rope
    tags:
      - "-inv:silver"
      - +inv:rope
    text: You tuck the coil of sturdy hemp rope into your pack.
    log: Bought rope
    options:
      - label: Continue shopping
        tags: []
        pass: stall_provisioner
  - id: buy_lantern
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - +inv:lantern
    text: The brass lantern is well-made, with a small reservoir of oil already inside.
    log: Bought lantern
    options:
      - label: Continue shopping
        tags: []
        pass: stall_provisioner
  - id: buy_rations
    tags:
      - "-inv:silver"
      - +inv:rations
    text: Dried meat, hard cheese, and twice-baked bread. It'll keep you going.
    log: Bought rations
    options:
      - label: Continue shopping
        tags: []
        pass: stall_provisioner
  - id: buy_lockpicks
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - +inv:lockpicks
    text: The merchant glances around before sliding a leather roll of picks across the counter.
    log: Bought lockpicks
    options:
      - label: Continue shopping
        tags: []
        pass: stall_provisioner
  - id: stall_apothecary
    tags:
      - "!q:bitter_medicine"
    vars:
      apothecary:
        - name: Earnest
          desc: A hooded figure
          gender: male
        - name: Edam
          desc: An elderly man with knowing eyes
          gender: male
        - name: Silas
          desc: A pale man who rarely blinks
          gender: male
    text: >-
      {{apothecary.desc}} presides over a cluttered tent that smells of herbs and something faintly sulfurous. Bottles
      and pouches crowd every surface.
    options:
      - label: Buy healer's kit (2 silver)
        tags:
          - inv:silver
          - inv:silver
          - "!inv:healers_kit"
        pass: buy_healers_kit
      - label: Buy antidote (2 silver)
        tags:
          - inv:silver
          - inv:silver
          - "!inv:antidote"
        pass: buy_antidote
      - label: Buy the cheap 'healing tonic' (1 silver)
        tags:
          - inv:silver
        pass: buy_dubious_tonic
      - label: Ask {{apothecary.him}} about removing a curse
        tags:
          - "@status:cursed"
        pass: apothecary_curse
      - Ask {{apothecary.him}} about removing a curse::apothecary_not_cursed
      - label: Browse other stalls
        tags:
          - "!status:banned_from_market"
        pass: Market
      - label: Leave the market
        tags: []
        pass: null
  - id: buy_healers_kit
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - +inv:healers_kit
    text: Clean bandages, salves, and a needle with thread. Proper supplies for treating wounds.
    log: Bought healer's kit
    options:
      - label: Continue shopping
        tags: []
        pass: stall_apothecary
  - id: buy_antidote
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - +inv:antidote
    text: A small vial of murky liquid that the apothecary assures you will neutralize most common poisons.
    log: Bought antidote
    options:
      - label: Continue shopping
        tags: []
        pass: stall_apothecary
  - id: buy_dubious_tonic
    tags:
      - "-inv:silver"
      - +inv:dubious_tonic
    text: The bottle is unlabeled. The apothecary winks. 'Healing. Probably.'
    log: Bought dubious tonic
    options:
      - label: Continue shopping
        tags: []
        pass: stall_apothecary
  - id: apothecary_not_cursed
    tags: []
    text: >-
      The apothecary eyes you suspiciously. Are you planning to get into trouble?  It'll cost 5 silver to lift any curse
      you might be afflicted with.
    options:
      - Review the apothecary's other items::stall_apothecary
      - Check out the other stalls::Market
      - Leave the market
  - id: apothecary_curse
    tags: []
    text: The apothecary's eyes widen slightly. 'I sense it on you. Dark magic. I can lift it... for 5 silver.'
    options:
      - label: Pay 5 silver
        tags:
          - inv:silver
          - inv:silver
          - inv:silver
          - inv:silver
          - inv:silver
        pass: curse_removed
      - label: Too expensive. Decline.
        tags: []
        pass: stall_apothecary
  - id: curse_removed
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - "-inv:silver"
      - "-inv:silver"
      - "-inv:silver"
      - "-status:cursed"
    text: The apothecary burns strange herbs and mutters words you don't recognize. A weight lifts from your shoulders.
    log: Had curse removed by apothecary
    options:
      - label: Continue shopping
        tags: []
        pass: stall_apothecary
  - id: stall_curios
    tags: []
    vars:
      dealer_desc:
        - A grinning merchant with too many rings
        - A nervous fellow who speaks in whispers
        - A scarred woman with a knowing smile
    text: >-
      {{dealer_desc}} beckons you toward a cart draped in velvet. Strange objects glint in the shadows: charms, bottles,
      things that seem to move when you're not looking directly at them.
    options:
      - label: Buy lucky charm (2 silver)
        tags:
          - inv:silver
          - inv:silver
          - "!inv:lucky_charm"
        pass: buy_lucky_charm
      - label: Buy smoke bomb (2 silver)
        tags:
          - inv:silver
          - inv:silver
        pass: buy_smoke_bomb
      - label: Buy forged papers (3 silver)
        tags:
          - inv:silver
          - inv:silver
          - inv:silver
          - "!inv:forged_papers"
        pass: buy_forged_papers
      - label: Examine the strange amulet
        tags:
          - "!inv:cursed_amulet"
        pass: examine_amulet
      - label: Buy the treasure map (2 silver)
        tags:
          - inv:silver
          - inv:silver
          - "!inv:treasure_map"
        pass: buy_treasure_map
      - label: Browse other stalls
        tags:
          - "!status:banned_from_market"
        pass: Market
      - label: Leave the market
        tags: []
        pass: null
  - id: buy_lucky_charm
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - +inv:lucky_charm
    text: A rabbit's foot on a silver chain. The dealer swears it belonged to a very lucky rabbit.
    log: Bought lucky charm
    options:
      - label: Continue shopping
        tags: []
        pass: stall_curios
  - id: buy_smoke_bomb
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - +inv:smoke_bomb
    text: A small clay sphere, sealed with wax. 'Throw it hard,' the dealer advises. 'Then run.'
    log: Bought smoke bomb
    options:
      - label: Continue shopping
        tags: []
        pass: stall_curios
  - id: buy_forged_papers
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - "-inv:silver"
      - +inv:forged_papers
    text: The documents look official enough. A seal, a signature, space for you to fill in your 'authorized purpose.'
    log: Bought forged papers
    options:
      - label: Continue shopping
        tags: []
        pass: stall_curios
  - id: examine_amulet
    tags: []
    text: >-
      An iron amulet set with a dark stone that seems to swallow light. The dealer's smile falters. 'That one... I'll
      give it to you. Free. Just take it away from me.'
    options:
      - label: Take the amulet
        tags: []
        pass: take_cursed_amulet
      - label: Refuse it
        tags: []
        pass: stall_curios
  - id: take_cursed_amulet
    tags:
      - +inv:cursed_amulet
      - +status:cursed
    text: The moment it touches your palm, you feel a chill. The dealer looks relieved. You feel... different.
    log: Accepted the cursed amulet
    options:
      - label: Continue shopping
        tags: []
        pass: stall_curios
  - id: buy_treasure_map
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - +inv:treasure_map
    text: >-
      'Genuine, I swear it,' the dealer says, which inspires no confidence whatsoever. The map shows a location in the
      hills.
    log: Bought treasure map
    options:
      - label: Continue shopping
        tags: []
        pass: stall_curios
  - id: stall_general
    tags: []
    vars:
      vendor_desc:
        - A farmer's wife
        - A young man minding his father's stall
        - A cheerful halfling
    text: >-
      {{vendor_desc}} tends a simple wooden stand piled with everyday goods: sacks of grain, jars of preserves, and
      sundry household items.
    options:
      - label: Buy flour (2 silver)
        tags:
          - inv:silver
          - inv:silver
          - "!inv:flour"
        pass: buy_flour
      - label: Buy iron nails (1 silver)
        tags:
          - inv:silver
          - "!inv:nails"
        pass: buy_nails
      - label: Buy beast bait (1 silver)
        tags:
          - inv:silver
        pass: buy_beast_bait
      - label: Buy cheap wine (1 silver)
        tags:
          - inv:silver
        pass: buy_wine
      - label: Buy silver mirror (3 silver)
        tags:
          - inv:silver
          - inv:silver
          - inv:silver
          - "!inv:mirror"
        pass: buy_mirror
      - label: Buy a caged songbird (3 silver)
        tags:
          - inv:silver
          - inv:silver
          - inv:silver
          - "!inv:songbird"
        pass: buy_songbird
      - label: Browse other stalls
        tags:
          - "!status:banned_from_market"
        pass: Market
      - label: Leave the market
        tags: []
        pass: null
  - id: buy_flour
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - +inv:flour
    text: A heavy sack of milled flour. Someone will be glad to have this.
    log: Bought flour
    options:
      - label: Continue shopping
        tags: []
        pass: stall_general
  - id: buy_nails
    tags:
      - "-inv:silver"
      - +inv:nails
    text: A pouch of iron nails, useful for repairs—or improvised defenses.
    log: Bought nails
    options:
      - label: Continue shopping
        tags: []
        pass: stall_general
  - id: buy_beast_bait
    tags:
      - "-inv:silver"
      - +inv:beast_bait
    text: A pungent packet of dried meat and herbs. Animals find it irresistible.
    log: Bought beast bait
    options:
      - label: Continue shopping
        tags: []
        pass: stall_general
  - id: buy_wine
    tags:
      - "-inv:silver"
      - +inv:wine
    text: A clay jug of wine. Not good wine, but wine nonetheless.
    log: Bought wine
    options:
      - label: Continue shopping
        tags: []
        pass: stall_general
  - id: buy_mirror
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - "-inv:silver"
      - +inv:mirror
    text: A small silver-backed mirror, polished to a gleam. Your reflection stares back.
    log: Bought silver mirror
    options:
      - label: Continue shopping
        tags: []
        pass: stall_general
  - id: buy_songbird
    tags:
      - "-inv:silver"
      - "-inv:silver"
      - "-inv:silver"
      - +inv:songbird
    text: A tiny bird in a wicker cage trills sweetly. It seems happy enough, for now.
    log: Bought caged songbird
    options:
      - label: Continue shopping
        tags: []
        pass: stall_general
